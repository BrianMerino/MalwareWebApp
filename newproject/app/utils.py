#app/utils.py
#connection to database
from django.http import request
from pymongo import MongoClient
from json import dump

client = MongoClient("mongodb://10.1.0.31:27017/")
mydb = client["malware"]
collection = mydb["analyses"]

#collection.drop_indexes()
#collection.create_index([('$**', 'text')],
                                #name = 'wildcard_Idx')
#collection.create_index([('Hash', 'text')],
                                #name = 'malware_hashIdx')
#print(list(collection.list_indexes()))

def search_malware(search_text): # html 7500, # PDF 50,000,
    docs = collection.find({"$text": {"$search": search_text}}).limit(1000)

    docs_list = []

    with open("info.json", "w", encoding='utf-8') as f:
        for document in docs:
            dump(document, f, ensure_ascii=False, default=str, indent=4)
            docs_list.append(document)
        return docs_list

#used to check if maybe polyglot
def check_polyglot(malware):
    if 'pe_info' in malware:
        pe_info = malware['pe_info']
        if 'resource_details' in pe_info:
            resource_details = "Possibly a polyglot"
        else: 
            resource_details = 'Not likely'
    else:
        resource_details = 'None'
    return resource_details

def count_docs():
    docs = collection.count()
    return docs